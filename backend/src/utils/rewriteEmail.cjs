const fs = require('fs');
const path = 'd:/CFL Project/GRADUS/backend/src/utils/email.js';
let text = fs.readFileSync(path, 'utf8');

const functionStart = 'const sendAdminApprovalEmail = async (';
const functionEnd = '\n};\n\nmodule.exports = { sendEmail, sendOtpEmail, sendAdminApprovalEmail, deliveryMode };\n';
const startIndex = text.indexOf(functionStart);
if (startIndex === -1) {
  throw new Error('sendAdminApprovalEmail function not found');
}
const endIndex = text.indexOf('\n};\n\nmodule.exports =', startIndex);
if (endIndex === -1) {
  throw new Error('Module exports block not found');
}
const newFunction = `const sendAdminApprovalEmail = async ({ to, requester, approvalOptions, rejectionUrl, portalName }) => {\n  if (!Array.isArray(approvalOptions) || approvalOptions.length === 0) {\n    throw new Error('At least one approval option is required');\n  }\n\n  if (!rejectionUrl) {\n    throw new Error('Rejection URL is required');\n  }\n\n  const subject = `${portalName || 'Gradus Admin Portal'}: Approval requested for ${requester.fullName}`;\n  const languageText = Array.isArray(requester.languages)\n    ? requester.languages.join(', ')\n    : requester.languages || 'Not provided';\n  const roleDisplay = requester.role || 'To be selected by approver';\n\n  const approvalText = approvalOptions\n    .map((option) => `Approve as ${option.label}: ${option.url}`)\n    .join('\\n');\n\n  const text = `A new admin signup request has been submitted.\\n\\n` +\n    `Full Name: ${requester.fullName}\\n` +\n    `Email: ${requester.email}\\n` +\n    `Phone Number: ${requester.phoneNumber}\\n` +\n    `Department: ${requester.department || 'Not provided'}\\n` +\n    `Designation: ${requester.designation || 'Not provided'}\\n` +\n    `Languages: ${languageText}\\n` +\n    `Role: ${roleDisplay}\\n` +\n    `Bio: ${requester.bio || 'Not provided'}\\n\\n` +\n    `${approvalText}\\nReject: ${rejectionUrl}`;\n\n  const approvalButtonsHtml = approvalOptions\n    .map((option) => `\n        <a href="${option.url}" style="background: #0B5394; color: #fff; padding: 10px 16px; text-decoration: none; border-radius: 4px; display: inline-block; margin-right: 12px; margin-bottom: 12px;">Approve as ${option.label}</a>\n      `)\n    .join('');\n\n  const html = `\n    <div style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">\n      <h2 style="color: #0B5394; margin-bottom: 12px;">${portalName || 'Gradus Admin Portal'} - Approval Needed</h2>\n      <p>A new admin signup request has been submitted with the following details:</p>\n      <table style="border-collapse: collapse; width: 100%; margin-bottom: 16px;">\n        <tbody>\n          <tr>\n            <td style="padding: 6px 8px; font-weight: bold; width: 180px;">Full Name</td>\n            <td style="padding: 6px 8px;">${requester.fullName}</td>\n          </tr>\n          <tr>\n            <td style="padding: 6px 8px; font-weight: bold;">Email</td>\n            <td style="padding: 6px 8px;"><a href="mailto:${requester.email}">${requester.email}</a></td>\n          </tr>\n          <tr>\n            <td style="padding: 6px 8px; font-weight: bold;">Phone Number</td>\n            <td style="padding: 6px 8px;">${requester.phoneNumber}</td>\n          </tr>\n          <tr>\n            <td style="padding: 6px 8px; font-weight: bold;">Department</td>\n            <td style="padding: 6px 8px;">${requester.department || 'Not provided'}</td>\n          </tr>\n          <tr>\n            <td style="padding: 6px 8px; font-weight: bold;">Designation</td>\n            <td style="padding: 6px 8px;">${requester.designation || 'Not provided'}</td>\n          </tr>\n          <tr>\n            <td style="padding: 6px 8px; font-weight: bold;">Languages</td>\n            <td style="padding: 6px 8px;">${languageText}</td>\n          </tr>\n          <tr>\n            <td style="padding: 6px 8px; font-weight: bold;">Role</td>\n            <td style="padding: 6px 8px;">${roleDisplay}</td>\n          </tr>\n          <tr>\n            <td style="padding: 6px 8px; font-weight: bold; vertical-align: top;">Bio</td>\n            <td style="padding: 6px 8px; white-space: pre-line;">${requester.bio || 'Not provided'}</td>\n          </tr>\n        </tbody>\n      </table>\n      <p>Please choose which role to assign to this admin:</p>\n      <div style="margin-bottom: 16px;">\n        ${approvalButtonsHtml}\n      </div>\n      <a href="${rejectionUrl}" style="background: #d9534f; color: #fff; padding: 10px 16px; text-decoration: none; border-radius: 4px; display: inline-block;">Reject</a>\n      <p style="margin-top: 20px;">If the buttons do not work, you can copy and paste these links into your browser:</p>\n      ${approvalOptions\n        .map((option) => `<p style="margin: 0; font-size: 14px;">Approve as ${option.label}: <a href="${option.url}">${option.url}</a></p>`)\n        .join('')}\n      <p style="margin: 0; font-size: 14px;">Reject: <a href="${rejectionUrl}">${rejectionUrl}</a></p>\n    </div>\n  `;\n\n  return sendEmail({ to, subject, text, html });\n};\n\n`;

text = text.slice(0, startIndex) + newFunction + text.slice(endIndex + 3);
fs.writeFileSync(path, text);